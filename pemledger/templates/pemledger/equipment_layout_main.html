<!-- D:/web/midbizsolution/pemledger/templates/pemledger/equipment_layout_main.html -->

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>레이아웃 작성 윈도우</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
  
        .head-container {
            width: 100%; /* 전체 너비 */
            height: 60px; /* 고정된 높이 */
            background-color: white; /* 배경색246,243,234 */
            display: flex; /* 플렉스 컨테이너 설정 */
            flex-direction: row; /* 자식 요소들을 수평으로 나열 */
            align-items: center; /* 자식 요소들을 수직 중앙 정렬 */
            justify-content: space-between; /* 좌우 공간을 균등하게 배분 */
            padding: 0 20px;
            
            box-sizing: border-box; /* 패딩과 테두리를 너비에 포함 */
            position: fixed; /* 화면 상단에 고정 */
            top: 0; /* 윈도우의 상단에 고정 */
            left: 0; /* 왼쪽 끝에 고정 */
            z-index: 1000; /* 다른 요소보다 위에 표시되도록 설정 */
        }

        .head-title {
            color: rgb(43, 43, 43); /* 검정색 글자 */
            font-size: 24px; /* 제목 크기 */
            font-weight: bold; /* 굵은 글씨 */
            margin: 150; /* 제목의 기본 마진 제거 */
        }

        .head-title-italic {
            font-style: italic; /* 글자 기울이기 */
            color: rgb(0, 0, 0); /* 글자색 변경 */
        }
        
        .head-nav {
            display: flex; /* 요소들을 가로로 정렬 */
            justify-content: center; /* 요소들을 중앙 정렬 */
            margin-right: 10%; /* 원하는 위치로 조정 */
        }

        .head-nav ul {
            list-style: none; /* 기본 리스트 스타일 제거 */
            margin: 0; /* 기본 마진 제거 */
            padding: 0; /* 기본 패딩 제거 */
            display: flex; /* 리스트 항목들을 수평으로 나열 */
        }

        .head-nav li {
            margin-left: 20px; /* 항목들 간의 간격 설정 */
        }

        .head-nav a {
            color: black; /* 링크 색상을 흰색으로 설정 */
            text-decoration: none; /* 기본 밑줄 제거 */
            font-size: 16px; /* 링크 글자 크기 */
        }

        .head-nav a:hover {
            text-decoration: none; /* 기본 밑줄 제거 */
            border-bottom: 2px solid black; /* 밑줄처럼 보이도록 아래쪽에 검정색 테두리 추가 */
        }
        
        /* 컨테이너: 전체 내용을 감싸는 영역 */
        .container {
            margin-top: 20px; /* 고정된 헤더 높이만큼 상단 여백 추가 */
            width: 50%;
            height: 70%;
            background-color: #fff;
            position: relative;
            border: 1px solid #ccc;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            margin-right: 40px;
        }

        /* 영역 1: 상단 헤더 */
        .header {
            width: 100%;
            height: 60px;
            background-color: rgb(100, 100, 100);
            position: relative;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .title {
            color: rgb(0, 0, 0); /* 검정색 글자 */
            position: absolute; /* 부모 요소(header)를 기준으로 위치를 설정 */
            left: 100px; /* 왼쪽 끝에서 100px 떨어진 위치 */
            top: 18px; /* 필요에 따라 위쪽 여백 설정 */
            font-size: 22px; /* 제목 크기 */
            font-weight: bold; /* 굵은 글씨 */
        }

        /* 맞춤, 회전, 삽입 버튼 위치 */
        .header-buttons {
            position: absolute;
            bottom: 5px;

            display: flex;
            align-items: center;
            margin-left: 70%;
        }

        .function-button {
            margin-right: 5px;
            padding: 5px 10px;
            background-color: #bbb;
            border: none;
            cursor: pointer;
            color: black;
            border-radius: 5px;
            font-size: 12px;
        }

        .function-button:hover {
            background-color: #ddd;
        }

        /* 영역 2: 좌측 패널 */
        .left-panel {
            position: absolute;
            top: 60px;
            left: 0;
            width: 120px;
            bottom: 0;
            background-color: rgb(64,64,64);
            padding-top: 10px;
            box-sizing: border-box;
        }

        .left-panel button {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 12px;
            text-align: left;
            padding-left: 10px;
        }

        .left-panel button:hover {
            background-color: #777;
        }

        .left-panel button.active {
            background-color: white;
            color: black;
        }

        /* 영역 3: 도형 그리기 영역 */
        .drawing-area {
            position: absolute;
            top: 60px;
            left: 120px;
            right: 0;
            bottom: 0;
            background-color: #fff;
            overflow: hidden;
        }

        /* 작은 사각형 */
        .small-rectangle {
            background-color: rgb(64,64,64);
            position: absolute;
            border: 2px solid rgb(64,64,64);
            cursor: pointer;
        }

        /* 화살표 본체 스타일 */
        .arrow-shape {
            position: absolute;
            display: flex; /* 자식 요소 정렬을 위한 플렉스 사용 */
            align-items: center; /* 자식 요소 수직 중앙 정렬 */
        }

        /* 화살표 끝부분 스타일 */
        .arrow-head {
            width: 0;
            height: 0;
            border-left: 10px solid black; /* 화살표 끝부분 색상 */
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            margin-left: -1px; /* 화살표 본체와 연결 부위 조정 */
        }

        /* 화살표 본체 스타일 */
        .arrow-body {
            width: 30px; /* 화살표 본체 길이 */
            height: 5px; /* 화살표 본체 높이 */
            background-color: black; /* 화살표 본체 색상 */
        }

        /* 점선 사각형 */
        .dashed-rectangle {
            width: 50px;
            height: 30px;
            border: 2px dashed red;
            position: absolute;
            cursor: pointer;
            box-sizing: border-box; /* 리사이즈 핸들러가 영역을 벗어나지 않도록 함 */
        }

        /* 리사이즈 핸들러 */
        .resize-handle {
            width: 8px;
            height: 8px;
            background-color: blue;
            position: absolute;
            display: none; /* 초기에는 숨김 */
        }

        .top-left {
            top: -4px;
            left: -4px;
            cursor: nwse-resize;
        }

        .top-right {
            top: -4px;
            right: -4px;
            cursor: nesw-resize;
        }

        .bottom-left {
            bottom: -4px;
            left: -4px;
            cursor: nesw-resize;
        }

        .bottom-right {
            bottom: -4px;
            right: -4px;
            cursor: nwse-resize;
        }

        /* 선택된 도형 스타일 */
        .selected {
            background-color: green;
        }

        /* 선택 박스 */
        .selection-box {
            position: absolute;
            border: 1px dashed black;
            background-color: rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        /* 회전 입력 상자 */
        .rotate-input {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 3;
            font-size: 12px;
        }

        .rotate-input input {
            width: 50px;
            font-size: 12px;
        }

        /* Alt 드래그 미리보기 */
        .preview-rectangle {
            position: absolute;
            border: 1px dashed blue;
            background-color: rgba(0, 0, 255, 0.1);
            pointer-events: none;
        }

        /* 폼을 감싸는 컨테이너 */
        .form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30%; /* 컨테이너 너비 설정 */
            margin-left: 40px;
        }

        /* 표: 상단 헤더 */
        .form-header {
            width: 100%;
            height: 40px;
            background-color: transparent;
            position: relative;
            color: black;
            display: flex;
            align-items: left;
            justify-content: center;
            font-size: 24px;
            font-weight: bold; /* 굵은 글씨 */
            margin-bottom: 10px;
        }        
        form {
            width: 30%; /* 폼의 너비를 50%로 설정 */
            background-color: #ffffff; /* 폼의 배경을 흰색으로 설정 */
            padding: 8px; /* 폼 안쪽 여백 설정 */
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
            border-radius: 10px; /* 모서리 둥글게 설정 */
        }

        /* 테이블 열 폭 조정 스타일 */
        table {
            width: 100%; /* 테이블 너비를 폼 내에서 100%로 설정 */
            border-collapse: collapse; /* 경계선 겹침 방지 */
            table-layout: fixed; /* 고정된 테이블 레이아웃 */
        }

        th, td {
            font-size: 14px; /* 글자 크기 설정 */
            border: 1px solid #dddddd; /* 테두리 스타일 */
            padding: 8px; /* 패딩 */
            text-align: center; /* 텍스트 중앙 정렬 */
            word-wrap: break-word; /* 긴 단어 줄바꿈 */
            overflow-wrap: break-word; /* 긴 단어 줄바꿈 */
        }
        
        /* 버튼 컨테이너 스타일 =========== 0928 추가 */
        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .button-container button {
            margin: 0 5px;
            padding: 5px 10px;
            font-size: 14px;
        }

        /* 폼 버튼 스타일 */
        .form-buttons {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .form-buttons button {
            margin: 0 5px;
            padding: 5px 10px;
            font-size: 14px;
        }

        /* 도형 내 레이블 스타일 */
        .shape-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 공통 헤더 -->
    <header class="head-container">
            <h1 class="head-title">Hanon management <span class="head-title-italic">solutions</span></h1>
            <nav class="head-nav">
                <ul class="head-nav-ul">
                    <li><a href="{% url 'solutions' %}">메인</a></li>
                    <li><a href="{% url 'greetings' %}">설비관리대장</a></li>
                    <li><a href="{% url 'checkpoint' %}">설비이력카드</a></li>
                    <li><a href="{% url 'doc_index' %}">설비등급기준</a></li>
                    <li><a href="{% url 'solutions' %}">설비점검기준</a></li>                    
                </ul>
            </nav>
    </header>

    <div class="container">
        <!-- 영역 1: 상단 헤더 -->
        <div class="header">
            <!-- 타이틀 추가 -->
            <span>공정 레이아웃</span>
            <div class="header-buttons">

                <button class="function-button" id="rotateButton">회전</button>
                <!-- 맞춤 옵션 드롭다운 -->                
                <select class="function-button" id="alignSelect">
                    <option value="">맞춤</option>
                    <option value="left">왼쪽 맞춤</option>
                    <option value="center">가운데 맞춤</option>
                    <option value="right">오른쪽 맞춤</option>
                    <option value="top">위쪽 맞춤</option>
                    <option value="middle">중간 맞춤</option>
                    <option value="bottom">아래쪽 맞춤</option>
                    <option value="horizontal">가로 간격 동일</option>
                    <option value="vertical">세로 간격 동일</option>
                </select>

                <!-- 삽입 버튼 추가 -->
                <select class="function-button" id="insertSelect">
                    <option value="">삽입</option>
                    <option value="arrow">화살표</option>
                    <option value="dashedRectangle">사각형(점선)</option>
                </select>
            </div>
        </div>

        <!-- 회전 입력 상자 -->
        <div class="rotate-input" id="rotateInput">
            <label for="rotateDegree">각도 입력:</label>
            <input type="number" id="rotateDegree" min="0" max="360" value="0">
            <button id="applyRotation">적용</button>
        </div>

        <!-- 영역 2: 좌측 패널 -->
        <div class="left-panel" id="leftPanel">
            <!-- 추가 버튼 -->
            <button id="addButton">추가</button>
            <!-- 기계 장비 버튼들 -->
            <!-- 버튼들은 JavaScript에서 동적으로 생성됩니다 -->
        </div>

        <!-- 도형 그리기 영역 -->
        <div class="drawing-area" id="drawingArea"></div>

        <!-- 추가 입력 창 -->
        <div class="rotate-input" id="addMachineInput">
            <label for="machineName">이름:</label><br>
            <input type="text" id="machineName"><br>
            <label for="machineWidth">가로(px):</label><br>
            <input type="number" id="machineWidth"><br>
            <label for="machineHeight">세로(px):</label><br>
            <input type="number" id="machineHeight"><br>
            <button id="confirmAddMachine">확인</button>
        </div>
    </div>

    <!-- 폼 컨테이너 -->
    <form method="post" id="equipmentForm" class="hidden">
        {% csrf_token %}
        <div class="form-header">
            <!-- 타이틀 추가 -->
            <span>설비관리대장</span>
        </div>

        <!-- 버튼 컨테이너 -->
        <div class="button-container">
            <button type="button" id="createButton">생성</button>
            <button type="button" id="updateButton">변경</button>
            <button type="button" id="viewButton">조회</button>
        </div>

        <table>
            <!-- 1행 : 설비번호, 설비이름, 모델명 -->
            <tr>
                <th>회사명</th>
                <th>위치</th>
                <th>공장명</th>
                <th>층</th>
            </tr>
            <tr>
                <td>{{ form.company_name }}</td>
                <td>{{ form.plant_location }}</td>
                <td>{{ form.plant_name }}</td>
                <td>{{ form.plant_floor }}</td>
            </tr>

            <tr>
                <th>라인명</th>
                <th>공정번호</th>
                <th>공정명</th>
            </tr>
            <tr>
                <td>{{ form.line_name }}</td>
                <td>{{ form.process_number }}</td>
                <td>{{ form.process_name }}</td>
            </tr>
            <tr>
                <th>설비번호</th>
                <th>설비명</th>
                <th>모델명</th>
            </tr>
            <tr>
                <td>{{ form.equipment_number }}</td>
                <td>{{ form.name }}</td>
                <td>{{ form.model_name }}</td>            
            </tr>
    
            <!-- 2행 : 제조사, 제조일자, 제조번호 -->
            <tr>
                <td>제조사</td>
                <th>제조일자</th>
                <th>제조번호</th>        
            </tr>
            <tr>
                <td>{{ form.manufacturer }}</td>    
                <td>{{ form.mfg_date }}</td>
                <td>{{ form.mfg_number }}</td>        
            </tr>
    
            <!-- 3행 : 형식, 사양 -->
            <tr>
                <th>형식</th>
                <th colspan="2">사양</th>
            </tr>
            <tr>
                <td>{{ form.equipment_type }}</td>
                <td colspan="2">{{ form.specs }}</td>
            </tr>
    
            <!-- 4행 : 최초 설치 시점, 최초 양산 적용, 현 운영 장소 -->
            <tr>
                <th>최초설치</th>
                <th>최초양산</th>
                <th>현 운영 장소</th>
            </tr>
            <tr>
                <td>{{ form.first_install }}</td>
                <td>{{ form.first_implement }}</td>
                <td>{{ form.current_operation_place }}</td>
            </tr>
    
            <!-- 5행 : 관리부서, 전면 정비, 상태 -->
            <tr>
                <th>관리부서</th>
                <th>오버홀</th>
                <th>상태</th>
            </tr>
            <tr>
                <td>{{ form.management_team }}</td>
                <td>{{ form.overhaul }}</td>
                <td>{{ form.current_status }}</td>
            </tr>
        </table>    
   
        <!-- 폼 버튼들 -->
        <div class="form-buttons">
            <button type="button" id="saveButton">저장</button>
            <button type="button" id="sendButton">전송</button>
            <button type="button" id="cancelButton">취소</button>
        </div>
    </form>


    <script>
        // 사각형을 생성할 때마다 카운트를 위한 변수
        let rectangleCount = 0;

        // 요소 선택
        const drawingArea = document.getElementById('drawingArea');
        const rotateInput = document.getElementById('rotateInput');
        const rotateButton = document.getElementById('rotateButton');
        const applyRotation = document.getElementById('applyRotation');
        const rotateDegreeInput = document.getElementById('rotateDegree');
        const alignSelect = document.getElementById('alignSelect');
        const insertSelect = document.getElementById('insertSelect');
        const leftPanel = document.getElementById('leftPanel');
        const addButton = document.getElementById('addButton');
        const addMachineInput = document.getElementById('addMachineInput');
        const machineNameInput = document.getElementById('machineName');
        const machineWidthInput = document.getElementById('machineWidth');
        const machineHeightInput = document.getElementById('machineHeight');
        const confirmAddMachine = document.getElementById('confirmAddMachine');

        // 여러 개의 선택된 도형을 관리할 배열
        let selectedShapes = [];

        // 선택 박스 관련 변수
        let isSelecting = false;
        let selectionBox = null;
        let startX, startY;

        // 현재 선택된 기계 장비를 저장할 변수
        let selectedMachine = null;

        // Alt 드래그 중 도형 미리보기
        let previewRectangle = null;

        // Undo, Redo 스택
        let undoStack = [];
        let redoStack = [];

        // 기계 장비 목록과 크기
        let machines = [
            { name: '기본', width: 30, height: 20 },
            { name: '선반', width: 25, height: 15 },
            { name: '머시닝센터', width: 35, height: 25 },
            { name: '탭핑센터', width: 20, height: 15 },
            { name: '사출기(100t)', width: 30, height: 12 },
            { name: '사출기(300t)', width: 45, height: 15 },
            { name: '사출기(500t)', width: 60, height: 20 },
            { name: '사출기(1000t)', width: 80, height: 25 },
            { name: '프레스(150t)', width: 35, height: 18 },
            { name: '프레스(300t)', width: 45, height: 20 },
            { name: '프레스(450t)', width: 55, height: 25 },
            { name: '프레스(600t)', width: 65, height: 30 },
            { name: '프레스(850t)', width: 70, height: 75 },
            { name: '프레스(1000t)', width: 80, height: 40 },
            { name: '대형로', width: 100, height: 20 }
        ];

        // 기계 장비 버튼 생성 함수
        function createMachineButtons() {
            // 기존 버튼 제거
            const existingButtons = leftPanel.querySelectorAll('.machine-button');
            existingButtons.forEach(btn => btn.remove());

            // 버튼 생성
            machines.forEach(machine => {
                const button = document.createElement('button');
                button.className = 'machine-button';
                button.textContent = machine.name;
                button.addEventListener('click', () => {
                    if (selectedMachine === machine) {
                        // 이미 선택된 상태이면 선택 해제
                        selectedMachine = null;
                        button.classList.remove('active');
                    } else {
                        // 다른 버튼 비활성화
                        deactivateOtherButtons();
                        // 선택된 기계 장비 설정
                        selectedMachine = machine;
                        button.classList.add('active');
                    }
                });
                leftPanel.appendChild(button);
            });
        }

        // 초기 버튼 생성
        createMachineButtons();

        // 다른 버튼 비활성화 함수
        function deactivateOtherButtons() {
            const buttons = leftPanel.querySelectorAll('.machine-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            selectedMachine = null;
        }

        // 맞춤 옵션 변경 시 동작
        alignSelect.addEventListener('change', () => {
            const alignType = alignSelect.value;
            if (alignType) {
                alignShapes(alignType);
                alignSelect.value = ""; // 초기화
            }
        });

        // 회전 버튼 클릭 시 입력창 표시
        rotateButton.addEventListener('click', () => {
            // 회전 버튼의 부모 요소 기준으로 위치를 계산
            const rect = rotateButton.getBoundingClientRect();
            const parentRect = rotateButton.parentElement.getBoundingClientRect();

            // 회전 입력창 위치 설정
            rotateInput.style.left = `${rect.left - parentRect.left + 50}px`; // 부모 요소 기준 상대적인 x 위치
            rotateInput.style.top = `${rect.bottom - parentRect.top + 35}px`; // 부모 요소 기준 상대적인 y 위치
            rotateInput.style.display = 'block';
        });

        // 회전 각도 적용
        applyRotation.addEventListener('click', () => {
            const degree = parseInt(rotateDegreeInput.value) || 0;
            selectedShapes.forEach(shape => {
                shape.style.transform = `rotate(${degree}deg)`;
                shape.dataset.rotation = degree;
            });
            rotateInput.style.display = 'none';
            saveState(); // 상태 저장
        });

        // ESC 키를 눌러 선택 해제
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSelection();
                rotateInput.style.display = 'none';
                addMachineInput.style.display = 'none';
            }
        });

        // 도형 생성 함수
        function createRectangle(x, y, width, height) {
            // 사각형이 그리기 영역의 범위를 벗어나지 않도록 보정
            const maxLeft = drawingArea.clientWidth - width;
            const maxTop = drawingArea.clientHeight - height;
            const left = Math.min(x, maxLeft);
            const top = Math.min(y, maxTop);

            // 새로운 사각형 생성
            const newRectangle = document.createElement('div');
            rectangleCount++;
            const rectangleName = `PF${String(rectangleCount).padStart(3, '0')}`; // 예: PF001
            newRectangle.className = 'small-rectangle';
            newRectangle.style.left = `${left}px`;
            newRectangle.style.top = `${top}px`;
            newRectangle.style.width = `${width}px`;
            newRectangle.style.height = `${height}px`;
            newRectangle.setAttribute('data-name', rectangleName);
            newRectangle.setAttribute('id', rectangleName);

            // 클릭 및 드래그 이벤트 추가
            newRectangle.addEventListener('click', shapeClickHandler);
            newRectangle.addEventListener('mousedown', shapeMouseDownHandler);

            // 그리기 영역에 추가
            drawingArea.appendChild(newRectangle);
            saveState(); // 상태 저장
        }

        // 삽입 도형 생성 함수 (rectangleCount에 포함되지 않음)
        function createInsertShape(type) {
            const x = drawingArea.clientWidth / 2 - 25; // 중앙 위치
            const y = drawingArea.clientHeight / 2 - 15;

            if (type === 'arrow') {
                createArrowShape(x, y);
            } else if (type === 'dashedRectangle') {
                createDashedRectangle(x, y);
            }
        }

        // 점선 사각형 생성 함수
        function createDashedRectangle(x, y) {
            const dashedRect = document.createElement('div');
            dashedRect.className = 'dashed-rectangle';
            dashedRect.style.left = `${x}px`;
            dashedRect.style.top = `${y}px`;

            // 리사이즈 핸들 추가
            addResizeHandles(dashedRect);

            // 클릭 및 드래그 이벤트 추가
            dashedRect.addEventListener('click', shapeClickHandler);
            dashedRect.addEventListener('mousedown', shapeMouseDownHandler);

            drawingArea.appendChild(dashedRect);
            saveState(); // 상태 저장
        }

        // 리사이즈 핸들러 추가 함수
        function addResizeHandles(element) {
            const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
            handles.forEach(handleClass => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${handleClass}`;
                handle.style.display = 'none'; // 초기에는 숨김
                handle.addEventListener('mousedown', initResize);
                element.appendChild(handle);
            });
        }

        // 선택 토글 함수 수정
        function toggleShapeSelection(shape) {
            if (selectedShapes.includes(shape)) {
                shape.classList.remove('selected');
                selectedShapes = selectedShapes.filter(s => s !== shape);

                // 점선 사각형의 경우 리사이즈 핸들 숨기기
                if (shape.classList.contains('dashed-rectangle')) {
                    const handles = shape.querySelectorAll('.resize-handle');
                    handles.forEach(handle => handle.style.display = 'none');
                }
            } else {
                shape.classList.add('selected');
                selectedShapes.push(shape);

                // 점선 사각형의 경우 리사이즈 핸들 보이기
                if (shape.classList.contains('dashed-rectangle')) {
                    const handles = shape.querySelectorAll('.resize-handle');
                    handles.forEach(handle => handle.style.display = 'block');
                }
            }
        }

        // 선택 해제 시 리사이즈 핸들 숨기기
        function clearSelection() {
            selectedShapes.forEach(shape => {
                shape.classList.remove('selected');

                if (shape.classList.contains('dashed-rectangle')) {
                    const handles = shape.querySelectorAll('.resize-handle');
                    handles.forEach(handle => handle.style.display = 'none');
                }
            });
            selectedShapes = [];
        }

        // 리사이즈 관련 변수
        let isResizing = false;
        let currentHandle = null;
        let currentElement = null;
        let initialMouseX = 0;
        let initialMouseY = 0;
        let initialElementX = 0;
        let initialElementY = 0;
        let initialElementWidth = 0;
        let initialElementHeight = 0;

        // 리사이즈 초기화 함수
        function initResize(e) {
            e.stopPropagation();
            isResizing = true;
            currentHandle = e.target;
            currentElement = currentHandle.parentElement;
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;
            initialElementX = parseInt(currentElement.style.left);
            initialElementY = parseInt(currentElement.style.top);
            initialElementWidth = currentElement.offsetWidth;
            initialElementHeight = currentElement.offsetHeight;

            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        // 리사이즈 동작 함수
        function doResize(e) {
            if (!isResizing) return;
            const dx = e.clientX - initialMouseX;
            const dy = e.clientY - initialMouseY;

            if (currentHandle.classList.contains('top-left')) {
                const newWidth = initialElementWidth - dx;
                const newHeight = initialElementHeight - dy;
                const newX = initialElementX + dx;
                const newY = initialElementY + dy;
                if (newWidth > 20 && newHeight > 20) {
                    currentElement.style.width = `${newWidth}px`;
                    currentElement.style.height = `${newHeight}px`;
                    currentElement.style.left = `${newX}px`;
                    currentElement.style.top = `${newY}px`;
                }
            } else if (currentHandle.classList.contains('top-right')) {
                const newWidth = initialElementWidth + dx;
                const newHeight = initialElementHeight - dy;
                const newY = initialElementY + dy;
                if (newWidth > 20 && newHeight > 20) {
                    currentElement.style.width = `${newWidth}px`;
                    currentElement.style.height = `${newHeight}px`;
                    currentElement.style.top = `${newY}px`;
                }
            } else if (currentHandle.classList.contains('bottom-left')) {
                const newWidth = initialElementWidth - dx;
                const newHeight = initialElementHeight + dy;
                const newX = initialElementX + dx;
                if (newWidth > 20 && newHeight > 20) {
                    currentElement.style.width = `${newWidth}px`;
                    currentElement.style.height = `${newHeight}px`;
                    currentElement.style.left = `${newX}px`;
                }
            } else if (currentHandle.classList.contains('bottom-right')) {
                const newWidth = initialElementWidth + dx;
                const newHeight = initialElementHeight + dy;
                if (newWidth > 20 && newHeight > 20) {
                    currentElement.style.width = `${newWidth}px`;
                    currentElement.style.height = `${newHeight}px`;
                }
            }
        }

        // 리사이즈 종료 함수
        function stopResize(e) {
            isResizing = false;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            saveState(); // 상태 저장
        }

        // 삽입 버튼 변경 시 동작
        insertSelect.addEventListener('change', () => {
            const insertType = insertSelect.value;
            if (insertType) {
                createInsertShape(insertType);
                insertSelect.value = ""; // 초기화
            }
        });

        // 마우스 드래그로 다중 선택 기능
        drawingArea.addEventListener('mousedown', (e) => {
            if (!e.target.classList.contains('small-rectangle') && !e.target.classList.contains('arrow-shape') && !e.target.classList.contains('dashed-rectangle')) {
                isSelecting = true;
                const rect = drawingArea.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                selectionBox.style.left = `${startX}px`;
                selectionBox.style.top = `${startY}px`;
                drawingArea.appendChild(selectionBox);
            }
        });

        drawingArea.addEventListener('mousemove', (e) => {
            if (isSelecting) {
                const rect = drawingArea.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                selectionBox.style.width = `${Math.abs(currentX - startX)}px`;
                selectionBox.style.height = `${Math.abs(currentY - startY)}px`;
                selectionBox.style.left = `${Math.min(currentX, startX)}px`;
                selectionBox.style.top = `${Math.min(currentY, startY)}px`;
            } else if (isDragging) {
                const dx = e.clientX - offsetX;
                const dy = e.clientY - offsetY;

                selectedShapes.forEach(shape => {
                    let currentLeft = parseInt(shape.style.left) + dx;
                    let currentTop = parseInt(shape.style.top) + dy;

                    if (e.altKey) {
                        // 눈금선에 맞추기 위해 10px 단위로 스냅 설정
                        currentLeft = Math.round(currentLeft / 10) * 10;
                        currentTop = Math.round(currentTop / 10) * 10;
                    }

                    shape.style.left = `${currentLeft}px`;
                    shape.style.top = `${currentTop}px`;
                });

                offsetX = e.clientX;
                offsetY = e.clientY;
            }
        });

        drawingArea.addEventListener('mouseup', (e) => {
            if (isSelecting) {
                isSelecting = false;

                // 선택 박스 범위 계산
                const selectRect = selectionBox.getBoundingClientRect();
                selectionBox.remove();
                selectionBox = null;

                const drawingRect = drawingArea.getBoundingClientRect();
                const selectLeft = selectRect.left - drawingRect.left;
                const selectTop = selectRect.top - drawingRect.top;
                const selectRight = selectRect.right - drawingRect.left;
                const selectBottom = selectRect.bottom - drawingRect.top;

                // 도형들 중에서 선택 박스 안에 있는 것 선택
                const shapes = drawingArea.querySelectorAll('.small-rectangle, .arrow-shape, .dashed-rectangle');
                shapes.forEach(shape => {
                    const rectBounds = shape.getBoundingClientRect();
                    const rectLeft = rectBounds.left - drawingRect.left;
                    const rectTop = rectBounds.top - drawingRect.top;
                    const rectRight = rectBounds.right - drawingRect.left;
                    const rectBottom = rectBounds.bottom - drawingRect.top;

                    if (rectRight >= selectLeft && rectLeft <= selectRight && rectBottom >= selectTop && rectTop <= selectBottom) {
                        if (!selectedShapes.includes(shape)) {
                            shape.classList.add('selected');
                            selectedShapes.push(shape);

                            // 점선 사각형의 경우 리사이즈 핸들 보이기
                            if (shape.classList.contains('dashed-rectangle')) {
                                const handles = shape.querySelectorAll('.resize-handle');
                                handles.forEach(handle => handle.style.display = 'block');
                            }
                        }
                    }
                });
            } else if (isDragging) {
                isDragging = false;
                saveState(); // 상태 저장
            }
        });

        // 도형 클릭 이벤트 핸들러
        function shapeClickHandler(e) {
            e.stopPropagation(); // 부모 요소로 이벤트 버블링 방지
            if (e.ctrlKey) {
                toggleShapeSelection(this);
            } else {
                clearSelection();
                toggleShapeSelection(this);
            }
        }

        // 도형 마우스 다운 이벤트 핸들러
        function shapeMouseDownHandler(e) {
            if (selectedShapes.includes(this)) {
                isDragging = true;
                offsetX = e.clientX;
                offsetY = e.clientY;
            }
        }

        // 도형 이동 시 눈금선 맞춤 기능
        let isDragging = false;
        let offsetX, offsetY;

        // 도형 그리기 윈도우 내에서 Alt + 마우스 드래그로 도형 생성
        let isAltDrawing = false;
        let altStartX, altStartY;

        drawingArea.addEventListener('mousedown', (e) => {
            if (e.altKey && !selectedMachine) {
                isAltDrawing = true;
                const rect = drawingArea.getBoundingClientRect();
                altStartX = e.clientX - rect.left;
                altStartY = e.clientY - rect.top;

                // 미리보기 사각형 생성
                previewRectangle = document.createElement('div');
                previewRectangle.className = 'preview-rectangle';
                previewRectangle.style.left = `${altStartX}px`;
                previewRectangle.style.top = `${altStartY}px`;
                drawingArea.appendChild(previewRectangle);
            }
        });

        drawingArea.addEventListener('mousemove', (e) => {
            if (isAltDrawing) {
                const rect = drawingArea.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                previewRectangle.style.width = `${Math.abs(currentX - altStartX)}px`;
                previewRectangle.style.height = `${Math.abs(currentY - altStartY)}px`;
                previewRectangle.style.left = `${Math.min(currentX, altStartX)}px`;
                previewRectangle.style.top = `${Math.min(currentY, altStartY)}px`;
            }
        });

        drawingArea.addEventListener('mouseup', (e) => {
            if (isAltDrawing) {
                isAltDrawing = false;
                previewRectangle.remove();
                previewRectangle = null;
                const rect = drawingArea.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                const width = Math.abs(endX - altStartX);
                const height = Math.abs(endY - altStartY);
                const left = Math.min(altStartX, endX);
                const top = Math.min(altStartY, endY);
                createRectangle(left, top, width, height);
            }
        });

        // 도형 그리기 윈도우 내에서 Ctrl + 마우스 클릭 시 도형 생성
        drawingArea.addEventListener('click', (e) => {
            if (e.ctrlKey && selectedMachine) {
                const rect = drawingArea.getBoundingClientRect();
                const left = e.clientX - rect.left;
                const top = e.clientY - rect.top;
                const { width, height } = selectedMachine;
                createRectangle(left, top, width, height);
            }
        });

        // 정렬 함수 구현
        function alignShapes(option) {
            if (selectedShapes.length < 2) return;

            let referenceShape = selectedShapes[0]; // 첫 번째 도형을 기준으로 사용

            switch (option) {
                case 'left':
                    const left = referenceShape.offsetLeft;
                    selectedShapes.forEach(shape => {
                        shape.style.left = `${left}px`;
                    });
                    break;
                case 'center':
                    const centerX = referenceShape.offsetLeft + referenceShape.clientWidth / 2;
                    selectedShapes.forEach(shape => {
                        const newLeft = centerX - shape.clientWidth / 2;
                        shape.style.left = `${newLeft}px`;
                    });
                    break;
                case 'right':
                    const right = referenceShape.offsetLeft + referenceShape.clientWidth;
                    selectedShapes.forEach(shape => {
                        const newLeft = right - shape.clientWidth;
                        shape.style.left = `${newLeft}px`;
                    });
                    break;
                case 'top':
                    const top = referenceShape.offsetTop;
                    selectedShapes.forEach(shape => {
                        shape.style.top = `${top}px`;
                    });
                    break;
                case 'middle':
                    const centerY = referenceShape.offsetTop + referenceShape.clientHeight / 2;
                    selectedShapes.forEach(shape => {
                        const newTop = centerY - shape.clientHeight / 2;
                        shape.style.top = `${newTop}px`;
                    });
                    break;
                case 'bottom':
                    const bottom = referenceShape.offsetTop + referenceShape.clientHeight;
                    selectedShapes.forEach(shape => {
                        const newTop = bottom - shape.clientHeight;
                        shape.style.top = `${newTop}px`;
                    });
                    break;
                case 'horizontal':
                    if (selectedShapes.length < 3) return;

                    selectedShapes.sort((a, b) => a.offsetLeft - b.offsetLeft);
                    const firstShape = selectedShapes[0];
                    const lastShape = selectedShapes[selectedShapes.length - 1];
                    const totalSpace = lastShape.offsetLeft - firstShape.offsetLeft;
                    const gap = totalSpace / (selectedShapes.length - 1);

                    selectedShapes.forEach((shape, index) => {
                        const newLeft = firstShape.offsetLeft + gap * index;
                        shape.style.left = `${newLeft}px`;
                    });
                    break;
                case 'vertical':
                    if (selectedShapes.length < 3) return;

                    selectedShapes.sort((a, b) => a.offsetTop - b.offsetTop);
                    const firstShapeV = selectedShapes[0];
                    const lastShapeV = selectedShapes[selectedShapes.length - 1];
                    const totalSpaceV = lastShapeV.offsetTop - firstShapeV.offsetTop;
                    const gapV = totalSpaceV / (selectedShapes.length - 1);

                    selectedShapes.forEach((shape, index) => {
                        const newTop = firstShapeV.offsetTop + gapV * index;
                        shape.style.top = `${newTop}px`;
                    });
                    break;
            }
            saveState(); // 상태 저장
        }

        // 선택된 도형 삭제 (Delete 키)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete') {
                selectedShapes.forEach(shape => shape.remove());
                selectedShapes = [];
                saveState(); // 상태 저장
            }
        });

        // 상태 저장 함수
        function saveState() {
            const currentState = drawingArea.innerHTML;
            undoStack.push(currentState);
            redoStack = []; // Redo 스택 초기화
        }

        // 페이지 로드 시 초기 상태 저장
        saveState();

        // Undo 및 Redo 기능 구현
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') {
                undoAction();
            } else if (e.ctrlKey && e.key === 'y') {
                redoAction();
            }
        });

        function undoAction() {
            if (undoStack.length > 1) {
                const currentState = undoStack.pop();
                redoStack.push(currentState);
                const prevState = undoStack[undoStack.length - 1];
                drawingArea.innerHTML = prevState;
                reattachEventListeners();
            }
        }

        function redoAction() {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                drawingArea.innerHTML = nextState;
                undoStack.push(nextState);
                reattachEventListeners();
            }
        }

        // 기존 이벤트 리스너 재등록 함수
        function reattachEventListeners() {
            const shapes = drawingArea.querySelectorAll('.small-rectangle, .arrow-shape, .dashed-rectangle');
            shapes.forEach(shape => {
                shape.addEventListener('click', shapeClickHandler);
                shape.addEventListener('mousedown', shapeMouseDownHandler);

                // 리사이즈 핸들러 이벤트 재등록
                if (shape.classList.contains('dashed-rectangle')) {
                    const handles = shape.querySelectorAll('.resize-handle');
                    handles.forEach(handle => {
                        handle.addEventListener('mousedown', initResize);
                    });
                }
            });
        }

        // 추가 버튼 기능
        addButton.addEventListener('click', () => {
            deactivateOtherButtons();
            addMachineInput.style.display = 'block';
            
            // 부모 요소 기준으로 위치 계산
            const rect = addButton.getBoundingClientRect();
            const parentRect = addButton.parentElement.getBoundingClientRect(); // 부모 요소 기준

            // 입력창 위치 설정
            addMachineInput.style.left = '${rect.right - parentRect.left - 100}px'; // 부모 요소 기준 상대적인 x 위치
            addMachineInput.style.top = '${rect.top - parentRect.top + 80}px'; // 부모 요소 기준 상대적인 y 위치
        });

        confirmAddMachine.addEventListener('click', () => {
            const name = machineNameInput.value.trim();
            const width = parseInt(machineWidthInput.value);
            const height = parseInt(machineHeightInput.value);

            if (name && width > 0 && height > 0) {
                machines.push({ name, width, height });
                createMachineButtons();
                addMachineInput.style.display = 'none';
                machineNameInput.value = '';
                machineWidthInput.value = '';
                machineHeightInput.value = '';
            } else {
                alert('올바른 값을 입력하세요.');
            }
        });

        // 화살표 도형 생성 함수
        function createArrowShape(x, y) {
            const arrow = document.createElement('div');
            arrow.className = 'arrow-shape';
            arrow.style.left ='${x}px';
            arrow.style.top = '${y}px';

            // 화살표 본체 추가
            const arrowBody = document.createElement('div');
            arrowBody.className = 'arrow-body';
            arrow.appendChild(arrowBody);

            // 화살표 끝 모양 추가 (꼭지점)
            const arrowHead = document.createElement('div');
            arrowHead.className = 'arrow-head';
            arrow.appendChild(arrowHead);

            // 클릭 및 드래그 이벤트 추가
            arrow.addEventListener('click', shapeClickHandler);
            arrow.addEventListener('mousedown', shapeMouseDownHandler);

            drawingArea.appendChild(arrow);
            saveState(); // 상태 저장
        }

        // 버튼 요소  ==========================0928 추가
        // 버튼 요소 선택
        const createButton = document.getElementById('createButton');
        const saveButton = document.getElementById('saveButton');
        const sendButton = document.getElementById('sendButton');
        const cancelButton = document.getElementById('cancelButton');
        const equipmentForm = document.getElementById('equipmentForm');

        // 저장된 equipment_number를 저장할 변수
        let savedEquipmentNumber = '';

        // "생성" 버튼 클릭 시
        createButton.addEventListener('click', () => {
            if (selectedShapes.length === 1) {
                // 폼 표시
                equipmentForm.classList.remove('hidden');
            } else {
                alert('하나의 도형을 선택하세요.');
            }
        });

        // CSRF 토큰 가져오기 함수
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // "저장" 버튼 클릭 시
        saveButton.addEventListener('click', () => {
            // 폼 데이터 수집
            const formData = new FormData(equipmentForm);

            // AJAX로 데이터 전송
            fetch('', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest', // AJAX 요청임을 명시
                },
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || 'Network response was not ok');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('데이터가 저장되었습니다.');
                    // equipment_number 저장
                    savedEquipmentNumber = data.equipment_number;
                    // 폼에 equipment_number 표시
                    const equipmentNumberField = document.querySelector('[name="equipment_number"]');
                    equipmentNumberField.value = savedEquipmentNumber;
                } else {
                    alert('데이터 저장에 실패했습니다.');
                    console.error('Form errors:', data.errors);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('데이터 저장에 실패했습니다.');
            });
        });

        // "전송" 버튼 클릭 시
        sendButton.addEventListener('click', () => {
            if (selectedShapes.length === 1) {
                if (savedEquipmentNumber) {
                    const equipmentNumber = savedEquipmentNumber;
                    // 선택된 도형에 표시
                    const shape = selectedShapes[0];
                    let label = shape.querySelector('.shape-label');
                    if (!label) {
                        label = document.createElement('div');
                        label.className = 'shape-label';
                        shape.appendChild(label);
                    }
                    label.textContent = equipmentNumber;
                    // 폼 숨기기
                    equipmentForm.classList.add('hidden');
                } else {
                    alert('저장된 equipment_number가 없습니다. 먼저 저장을 누르세요.');
                }
            } else {
                alert('하나의 도형을 선택하세요.');
            }
        });

        // "취소" 버튼 클릭 시
        cancelButton.addEventListener('click', () => {
            // 폼 리셋 및 숨기기
            equipmentForm.reset();
            equipmentForm.classList.add('hidden');
            savedEquipmentNumber = '';
        });

    </script>
</body>
</html>

